<script setup>
import { nextTick, onMounted, ref } from 'vue'
import useFaceIDStore from '@/stores/useFaceIDStore'

const faceIDStore = useFaceIDStore()
const video = ref(null)
const canvas = ref(null)
const axis = ref(null)

const lam = [
  0.009928622993188061, 0.08383961198078799, 0.028281383831751775, 0.024818307683558707, 0, 0, 0,
  0.006150671909484119, 0.10360035475225678, 0.02387754454042117, 0, 0, 0.0097881580704929,
  0.015899742628717337, 0, 0.023118095949139855, 0, 0.016331482899926034, 0.05610483851751007, 0,
  0.018209995773211116, 0, 0, 0, 0, 0, 0.06936479847844877, 0, 0, 0.0743887869262,
  0.05229844432329213, 0, 0, 0.031506936162957425, 0.052974764374874084, 0.0012214485512645177,
  0.014765809983393238, 0, 0, 0, 0.04978153326185031, 0.0033447195225059954, 0.033065044714003754,
  0, 0.011283291223330227, 0, 0.0038508601930381994, 0.011241400123558712, 0, 0.11280362224273924,
  0.010298764388856452, 0, 0.10801860196726941, 0.05821854697282577, 0, 0.02782087019421708, 0,
  0.0030595895357721863, 0.005797413985731688, 0, 0.00007152251776025256, 0, 0.055683947355278984,
  0, 0.06988013458077548, 0, 0, 0, 0.0008771692861063293, 0.0004667604913105865, 0.0941731162662835,
  0, 0.014278540143662278, 0, 0, 0, 0.0005811974275878846, 0.0019709850145286176, 0, 0, 0,
  0.0009164386377810776, 0.05690971441239222, 0.00477612597942093, 0.011322358704426945,
  0.011488025845539089, 0, 0.018077713931766402, 0, 0.0962515846449959, 0, 0.09561754830019849, 0,
  0, 0.0346694740408062, 0, 0.0366585486118837, 0, 0, 0.06798807299706199, 0.00019503487797012202,
  0.08967349182662435, 0, 0, 0.0005859083263314904, 0.0006904169044369103, 0, 0.03924185616545426,
  0.03949733164691139, 0, 0.0028252093156010717, 0.0006363588842118143, 0.004254333444487433, 0,
  0.07628969552867809, 0, 0, 0.01289008167363506, 0, 0.023945689606890624, 0.00018034511058650336,
  0, 0, 0.004645224771713106, 0.0025173625937656955, 0, 0.07455850826573455, 0, 0.06673626369326308,
  0, 0.0021253338710049197, 0.003745765873361652, 0.002565877994762141, 0, 0, 0.028861987252808505,
  0.005561829222578216, 0.009693336282479028, 0.003529197883930494, 0.05085752588233137, 0,
  0.006568508548043221, 0.07848109221010958, 0.05786058256116332, 0.0011879722942131799,
  0.009920987369186134, 0, 0.007441796043649738, 0, 0, 0, 0.011032756560670471, 0, 0,
  0.028514045625415634, 0, 0, 0.006655141088204343, 0, 0.002349217506296502, 0.017076592085328645,
  0, 0.04286115016450368, 0.023158721525084056, 0.003473484002517301, 0.02623386083373059, 0,
  0.008732570737018427, 0.008304268689180303, 0.020381797733249295, 0.07860725815243, 0, 0,
  0.020828040482708598, 0.015280441722701812, 0, 0.005398175477116616, 0, 0.060550377743940925,
  0.0015862517248762863, 0.00008023104491490814, 0.0010534384438678633, 0, 0.0756261471956349,
  0.0035961531387453025, 0.004106186305684088, 0.013791175749362734, 0, 0.006780647889256823, 0,
  0.0005068075628766384, 0.005754729449797732, 0, 0.08356382508171482, 0.0615826614873284,
  0.0015851562964957157, 0.0475852855199438, 0.019156835075147028, 0, 0, 0.009471910038203501, 0, 0,
  0.06341657612243282, 0.004428928112783092, 0.004239940594722137, 0.0010646534379152007,
  0.07746628324728072, 0.002115006353805078, 0, 0, 0.11276057113655753, 0.0019081732025750479,
  0.11275666836248045, 0.006101764586652686, 0, 0, 0, 0.050238618268506896, 0.01615197584772138, 0,
  0.022758355556015363, 0.028880185581370166, 0.028799548348999504, 0.003045249102126429, 0,
  0.0041326804272826595, 0, 0, 0.050030335109264114, 0.02036757069656803, 0.03527962782007856,
  0.0780823405204871, 0.06422762410103798, 0.04576991180241764, 0.024784454407294605,
  0.045416620304941584, 0, 0.019048457724924424, 0.0005888964733815084, 0.0006002172846113474, 0, 0,
  0.0041973355394400325, 0, 0, 0, 0.04499627180371279, 0.09883624062893578, 0.0730040421211127, 0,
  0.0005330226457211912, 0, 0.002497628438642627, 0.009565568393917007, 0, 0, 0.030899813611303912,
  0.004068410385179942, 0.017392789414443586, 0, 0.0015820759073529788, 0, 0.00912359704431664, 0,
  0.0013607544096692758, 0.059020747932666325, 0.002911533868236273, 0.0019122188362720484, 0, 0, 0,
  0, 0, 0.05087341653127723, 0, 0.005231353125840506, 0, 0.06712767027436971, 0.0015701430180213613,
  0, 0, 0.12691570249430498, 0, 0, 0, 0.005606434655128233, 0, 0, 0.022142176321119075,
  0.016479273060974086, 0.028942084564889014, 0.00604621103689926, 0.0018960774121660382, 0, 0, 0,
  0.002709120286614859, 0.0037949205454630686, 0, 0, 0, 0, 0, 0, 0.0019351101204775718,
  0.00746387590576945, 0.003520704759620024, 0, 0.0045718709818353045, 0, 0.032921828801505314, 0,
  0, 0, 0.032186917805948775, 0.03250616691802357, 0, 0.11039859253198178, 0.011075528799392675, 0,
  0, 0, 0, 0, 0, 0.11134923594235799, 0, 0.05819564010081999, 0.0013310884276605357, 0, 0, 0, 0,
  0.005713317974649454, 0.00802432550015778, 0, 0.010343121444369437, 0, 0, 0.0012426339134618937,
  0, 0, 0, 0, 0.006169236123115506, 0, 0.000661260437943105, 0.0018474967479619308, 0, 0,
  0.000851790976934816, 0.001502075719258677, 0.021145235431039872, 0, 0, 0, 0, 0,
  0.045879447103516345, 0.009194137493190141, 0.0668653567161413, 0.0064210054765910796, 0,
  0.03627747451551765, 0, 0.0011962624345313157, 0.010459355731098687, 0.047334658358249564, 0,
  0.018699930955491207, 0.023675523908401795, 0.033379996389454346, 0, 0, 0.0036282924421593686,
  0.10022379740467133, 0, 0.0020335287505766995, 0.0012226502678874878, 0, 0.0042555359319356905,
  0.013968377862663717, 0.04035820577209051, 0, 0.06194158514823732, 0, 0.0009494470895302517,
  0.05268607968450406, 0.05756825820508096, 0, 0.007121069002557344, 0.028037024678705207,
  0.004665412514694149, 0.022880618724258697, 0.025927484846543468, 0.0010570772531076542, 0, 0, 0,
  0, 0, 0.0840660660614711, 0.11002375081500568, 0, 0, 0, 0.0004300192752838198, 0,
  0.019901759262480674, 0.09395980115956493, 0.013086612659252478, 0.0018909647849768446,
  0.06923339777595475, 0, 0, 0.032991612813830166, 0.04355525195640311, 0, 0.01458398977014852,
  0.02259251917592902, 0, 0, 0, 0.010285769987456908, 0.09954095445821334, 0, 0.028591780443637686,
  0.009694071478508648, 0.08788580752377567, 0.10053505460016693, 0.03513891965918162,
  0.019713975259635027, 0, 0.06045477622332528, 0, 0.0017944249130447379, 0.013312958481806346, 0,
  0.005712770517400931, 0, 0, 0, 0.0039633945183881955, 0.14374465068309591, 0.011908372291233786,
  0.0005449690244953374, 0, 0, 0, 0.01694306184950745, 0.019347080237487914, 0, 0, 0,
  0.0353585986994725, 0, 0.025759802596835697, 0, 0.00026671267955510083, 0.015743775553021137,
  0.025429878411003724, 0.037066955830349975, 0.015456407774830911, 0.0002310350953658018, 0,
  0.02801480024402049, 0, 0.0025572387562360923, 0.1188898558989135, 0.0018853548898300598,
  0.07307330539813232, 0, 0, 0.0022064061914266637, 0, 0.003651776576658114, 0,
  0.011766430809877089, 0.010825232578688473, 0.012238903544803168, 0, 0.011824992976374273, 0, 0,
  0.004263537098418326, 0.02804047797599251, 0.0029704214942992257, 0, 0.00974823274649862, 0, 0, 0,
  0, 0, 0, 0.012391177510900447, 0.00040687203425927095, 0, 0, 0.05435722890746691,
  0.02156089183309735, 0.07320535290868968, 0.0003020099042887224, 0.012095471116046239, 0,
  0.001156783675320172, 0.0015518821669641702, 0, 0.0010652157121386915, 0, 0.00012075867787103883,
  0.007572180627120533, 0, 0.029952711201003256, 0, 0.010971134389077037, 0, 0, 0, 0,
  0.08600430864462193, 0.07289196343915477, 0, 0.03822054897415857, 0.03615383825049579,
  0.023219233708263717, 0, 0.004761067479196384, 0, 0.023971698965030708, 0.047186298129077896,
  0.005004849027160968, 0.10279355487745741, 0, 0.013525296524649575, 0.007928288206313023,
  0.0025508056196824236, 0.012869476999820818, 0, 0, 0, 0, 0, 0, 0, 0, 0.0002999023608940549, 0,
  0.01480464861502687, 0.001705006610295153, 0.048664013371133366, 0.02247312553328871, 0,
  0.014415903265401164, 0, 0.0012964362338097268, 0.006179654255110238, 0, 0.06181334174612026,
  0.037702469418986966, 0, 0.0025456508540441887, 0, 0, 0, 0, 0.07991860120517717,
  0.015575306718931257, 0.0067366101267073075, 0, 0.014299350370886478, 0, 0.010946161705301174,
  0.033368531990602926, 0, 0.012030884864281203, 0, 0.013617939446517884, 0.0008973059833239001,
  0.04272412278000106, 0.004882172353974602, 0.001989120649300242, 0.0008787747438853596,
  0.0004829900036174893, 0.09611456000120541, 0, 0.018107527398346788, 0.009010451540161033,
  0.020759684381404922, 0.01392631478320587, 0, 0, 0, 0, 0, 0.00032254578194607, 0,
  0.06172699835108915, 0.09722290398770181, 0.02400420929234975, 0.03336249146106227,
  0.012577256790799506, 0.028590125053509486, 0, 0.0006280477174927848, 0, 0, 0,
  0.04931003759079957, 0.002408795449227899, 0.09690162674864876, 0, 0.0014750409921919145,
  0.05178930223038552, 0, 0.0066668158367119545, 0, 0.009430247787895073, 0, 0, 0,
  0.08336601692424353, 0.055137504170245225, 0.0015347611095651995, 0, 0, 0, 0, 0, 0,
  0.031605722391071366, 0, 0.037112152914131655, 0, 0, 0.01858456753004215, 0.001454196334771545,
  0.0030229311406401818, 0, 0, 0.011699990466354225, 0.007488941773757827, 0.010408881406105337, 0,
  0.011866832687793299, 0, 0.0026767915314746147, 0.00810180269143935, 0.06342950680227527, 0,
  0.006444677007281904, 0, 0, 0.004512762043267629, 0.009223413095014468, 0, 0, 0.03685031623981435,
  0, 0.006715282590068043, 0.00030347669916328484, 0, 0.0011431583962465625, 0.11278650923618216, 0,
  0, 0.0711406319420353, 0.098914515367448, 0.011268518784934541, 0.004098547598381012, 0, 0,
  0.02585871215699561, 0.041552271011963876, 0.012341243106197254, 0, 0.03369737907656671,
  0.08853429290293711, 0, 0, 0, 0.04732755991382566, 0.013653444001841987, 0.000144926620046913,
  0.003921499307548482, 0.01664313886903696, 0, 0, 0.008924442512010118, 0.04309792850779098, 0,
  0.023926921210205343, 0, 0.00446783663257611, 0.03584163002789011, 0.0007121412448046482, 0,
  0.005327731295756778, 0.06587475372286915, 0, 0.03050683112072093, 0.0021626353057210774,
  0.07497442777615677, 0, 0, 0.011934602276700559, 0, 0.002941134587037351, 0, 0, 0, 0, 0,
  0.11809304317912599, 0, 0, 0, 0, 0.06315680046363935, 0, 0, 0.011439180873908677, 0, 0,
  0.02651394242871582, 0.05961282397471088, 0.005441783975628335, 0.008179107903034588,
  0.026101572140505545, 0.053006929372464394, 0.015572644117094261, 0, 0, 0.041129206465011496, 0,
  0, 0.011674346993283865, 0, 0, 0.0027883078535617914, 0.011224720834696644, 0,
  0.0027625340253706163, 0.012098487269748362, 0.013841878923819172, 0, 0, 0, 0.0005317661576791927,
  0.09090993121678263, 0.005042599596077886, 0, 0.0010670261237969011, 0.004871580186759439,
  0.12812195568103282, 0.006674512441558835, 0, 0.028593748274949024, 0.003236035897702555, 0,
  0.02139421542474231, 0, 0.0015350891385485916, 0.06485776863460685, 0, 0.0025060588691630595, 0,
  0.006258248971763949, 0, 0, 0.05007391791359959, 0.0011363998857743802, 0.00628039735168698,
  0.002111392724858007, 0, 0, 0, 0, 0, 0.10392094133185237, 0.0014478051653724093, 0,
  0.01414321200068198, 0.01161233015914331, 0.04773268101844473, 0, 0, 0.007959996190155192,
  0.0007641839423159822, 0.06159137147048638, 0.027862263169558463, 0.0715748429652317,
  0.0015741012915191294, 0.03273905893150658, 0, 0.015239321448217642, 0, 0.005669231907048598,
  0.002649433571670692, 0, 0.044655658840562974, 0, 0.017946721595380164, 0.05304586941044694,
  0.0004174066465196456, 0, 0.003813182938170834, 0, 0.01586652793838017, 0.07776088239443328,
  0.00007845103803192141, 0.012198016230850284, 0, 0, 0, 0.00028702257693237525,
  0.049970993210165154, 0.0023645360315846446, 0.005011556920105948, 0.0710667642686326, 0,
  0.0025067072188769703, 0.05420337080975689, 0, 0, 0, 0.07315508276675023, 0, 0, 0,
  0.039639618457996816, 0.014226866757110835, 0.008048661653540805, 0.05921875890283544, 0, 0,
  0.014185688927671875, 0, 0.007552490665980606, 0.00805582313434376, 0, 0.1576524821036783, 0, 0,
  0, 0.0005187494451699416, 0, 0, 0.11053294224073068, 0.00337066961274621, 0.018621576736327146,
  0.0032271796290344918, 0.11408347999450504, 0.006999082646239421, 0, 0.05370076805599908,
  0.0007481088091846836, 0.012945992201143782, 0, 0.018198797223436574, 0.0001651273385869605, 0,
  0.055941360520213985, 0, 0.011385179252400438, 0, 0.07521412497786549, 0.03319893672382647, 0,
  0.007921650201527429, 0, 0.014051044592368707, 0, 0, 0.000758287214515051, 0.0011068395924772607,
  0.006235799113506311, 0.022031487180212476, 0.02339137509661152, 0.0002570349466606772, 0, 0,
  0.012651978196031564, 0.0037781696554965312, 0.031806257557114775, 0.10594061595389237,
  0.0033552599587796522, 0.04504377108568601, 0.027795348682836632, 0, 0.017033308018615644, 0,
  0.07529312874580502, 0.0005293556585347852, 0.1315976829564308, 0.004206920152357382,
  0.0006864103258878019, 0.0040927239276878705, 0.008175917028933997, 0.054945160992766695,
  0.07288074296368317, 0, 0, 0.11143852834364398, 0, 0.00804990251095892, 0, 0,
  0.012636434247170501, 0, 0, 0, 0.06855644736058225, 0, 0.03274748936202702, 0,
  0.03036383172448098, 0.027975295619338595, 0.0059341782618695625, 0, 0.008769954735687585, 0,
  0.0026464091958321692, 0.039500541020818875, 0.02428507473100495, 0, 0, 0, 0.007848233375270573,
  0, 0.03375290864508897, 0, 0.03393338179832043, 0.03591900307211064, 0, 0, 0.00043763511477003746,
  0.04239127151361128, 0.03201413783167403, 0, 0, 0, 0.03831811832608556, 0, 0.04554896381240929, 0,
  0, 0.0074361590839706415, 0.042189686654821014, 0, 0.06062985839579156, 0, 0, 0.03304437700381045,
  0.027020919359037537, 0.02304324436008149, 0, 0, 0, 0.005872399869684559, 0.015309527530210944,
  0.004434683265672915, 0, 0, 0.008513062306057813, 0.09928238471275831, 0.0005066527126411363,
  0.02810957681028417, 0.0025928272458692627, 0, 0, 0.09735098294709091, 0, 0, 0, 0, 0,
  0.005330192455252015, 0.036990446110451276, 0, 0.014180151318807593, 0, 0.0183903250390556,
  0.0031901156085068364, 0.005250016690286707, 0, 0.11066672188135596, 0.052141774254933874,
  0.0358684917475035, 0.06331545480758174, 0, 0, 0, 0.00974947428909477, 0.008752484066197178, 0,
  0.013693805099065379, 0, 0.08776572596239003, 0, 0.007456825423807873, 0.0003205366900700472,
  0.05823016211084449, 0.005908175070331775, 0, 0.002951025131946522, 0.029241490921122475, 0, 0, 0,
  0.00798910460853942, 0, 0, 0.0020227094468435324, 0.0016912158607265268, 0, 0,
  0.003166197756313078, 0.08278551765024784, 0, 0.007399282117046048, 0, 0,
]

const cosineSimilarity = (vec1, vec2) => {
  let dot = 0,
    normA = 0,
    normB = 0
  for (let i = 0; i < vec1.length; i++) {
    dot += vec1[i] * vec2[i]
    normA += vec1[i] * vec1[i]
    normB += vec2[i] * vec2[i]
  }
  return dot / (Math.sqrt(normA) * Math.sqrt(normB))
}

const handleUpdateInfo = async () => {
  faceIDStore.init(video, canvas, axis, false, (descriptors) => {
    descriptors.forEach((o) => {
      const similarity = cosineSimilarity(o, lam)
      console.log({ same: similarity > 0.5, similarity })
    })
  })
  await nextTick()
  await faceIDStore.startVideo()
}

onMounted(async () => {
  await faceIDStore.loadModels()
  await handleUpdateInfo()
})
</script>

<template>
  <div class="container">
    <div class="video-container">
      <canvas ref="canvas"></canvas>
      <video ref="video" autoplay muted></video>
      <div class="face-id-step" :class="faceIDStore.renderStyle()">
        <div class="dot"></div>
        <div class="dot"></div>
        <div class="dot"></div>
        <div class="dot"></div>
        <div class="dot"></div>
        <div class="dot"></div>
        <div class="dot"></div>
        <div class="dot"></div>
        <div class="dot"></div>
        <div class="dot"></div>
        <div class="dot"></div>
        <div class="dot"></div>
        <div class="dot"></div>
        <div class="dot"></div>
        <div class="dot"></div>
        <div class="dot"></div>
        <div class="dot"></div>
        <div class="dot"></div>
        <div class="dot"></div>
        <div class="dot"></div>
        <div class="dot"></div>
        <div class="dot"></div>
        <div class="dot"></div>
        <div class="dot"></div>
        <div class="dot"></div>
        <div class="dot"></div>
        <div class="dot"></div>
        <div class="dot"></div>
        <div class="dot"></div>
        <div class="dot"></div>
        <div class="dot"></div>
        <div class="dot"></div>
        <div class="dot"></div>
        <div class="dot"></div>
        <div class="dot"></div>
        <div class="dot"></div>
        <div class="axis" ref="axis">
          <div class="a-x">
            <div class="a-x__left"></div>
            <div class="a-x__right"></div>
          </div>
          <div class="a-y">
            <div class="a-y__top"></div>
            <div class="a-y__bottom"></div>
          </div>
        </div>
      </div>
      <div class="face-background"></div>
      <div class="face-id-loading" v-show="faceIDStore.isLoading">
        <div class="bg-loading">
          <div></div>
          <div></div>
          <div></div>
        </div>
      </div>
    </div>
    <div class="face-id-text" v-show="faceIDStore.textStep != null">
      {{ faceIDStore.textStep }}
    </div>
  </div>
  <div class="container mt-4">
    <img id="image" />
  </div>
</template>
